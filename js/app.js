import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
const supabase = createClient('https://peeagzvflrzibavfnqyc.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBlZWFnenZmbHJ6aWJhdmZucXljIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxOTc2NTUsImV4cCI6MjA3NDc3MzY1NX0.AmvYrGOlhEkv2QYzrqKdUz_nAD1bKTh8vqVZCNsg100');
const $=id=>document.getElementById(id);
const fmt={num:x=>x==null?'—':new Intl.NumberFormat('es-MX',{maximumFractionDigits:2}).format(x),pct:x=>x==null?'—':(x*100).toFixed(0)+'%'};
document.querySelectorAll('#sidebarNav .nav-item').forEach(el=>{el.addEventListener('click',e=>{e.preventDefault();const v=el.getAttribute('data-view');document.querySelectorAll('#sidebarNav .nav-item').forEach(i=>{i.classList.remove('bg-gray-100','text-gray-900');i.classList.add('text-gray-700');});el.classList.add('bg-gray-100','text-gray-900');['dashboard','control','sprint','upload'].forEach(s=>{const sec=$('view-'+s);if(sec)sec.classList.toggle('hidden',s!==v);});window.scrollTo({top:0,behavior:'smooth'});});});
async function loadSprint(){const {data}=await supabase.from('sprint').select('*').order('created_at',{ascending:false}).limit(1).maybeSingle();if(!data)return;$('sprintName').textContent=data.nombre;$('sprintDates').textContent=new Date(data.fecha_inicio).toLocaleDateString('es-MX')+' – '+new Date(data.fecha_fin).toLocaleDateString('es-MX');$('diasRestantes')&&($('diasRestantes').textContent='—');}
async function loadKpis(){const {data}=await supabase.from('vw_kpis').select('*').limit(1).maybeSingle();if(!data)return;$('kpiTotal').textContent=fmt.num(data.horas_sprint);$('kpiPendientes').textContent=fmt.num(data.horas_pendientes);$('kpiTerminadas').textContent=fmt.num(data.horas_terminadas);$('kpiAvance').textContent=fmt.pct(data.avance);}
async function loadBurndownChartAndTable(){const {data}=await supabase.from('burndown_diario').select('*').order('dia');const rows=data||[];if(rows.length===0)return;const labels=rows.map(r=>'Día '+r.dia),estimada=rows.map(r=>r.estimacion),real=rows.map(r=>r.real),completadas=rows.map((r,i)=>{if(i===0)return 0;const p=real[i-1]!=null?real[i-1]:real[i],c=real[i]!=null?real[i]:real[i-1];const d=(p!=null&&c!=null)?(p-c):0;return Math.max(0,d);});const ctx=$('burndownChart').getContext('2d');if(window.__bdChart)window.__bdChart.destroy();window.__bdChart=new Chart(ctx,{data:{labels,datasets:[{type:'bar',label:'Completadas (h)',data:completadas,borderWidth:1},{type:'line',label:'Estimación',data:estimada,tension:.25,borderWidth:2,pointRadius:2},{type:'line',label:'Real',data:real,tension:.25,borderWidth:2,pointRadius:2}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom'},tooltip:{mode:'index',intersect:false}},interaction:{mode:'index',intersect:false},scales:{y:{beginAtZero:true}}}});const tbody=$('bdBody'),fmtDate=d=>new Date(d).toLocaleDateString('es-MX');tbody.innerHTML=rows.map(r=>'<tr class="border-b last:border-0"><td class="py-2 pr-4">'+r.dia+'</td><td class="py-2 pr-4">'+fmtDate(r.fecha)+'</td><td class="py-2 pr-4">'+fmt.num(r.estimacion)+'</td><td class="py-2 pr-4"><input data-fecha="'+r.fecha+'" value="'+(r.real==null?'':r.real)+'" class="bd-real w-32 px-2 py-1 rounded border" placeholder="—" /></td><td class="py-2 pr-4"><label class="inline-flex items-center gap-2 text-sm"><input type="checkbox" class="bd-manual" data-fecha="'+r.fecha+'" '+(r.manual_edit?'checked':'')+' />Manual</label></td></tr>').join('');tbody.querySelectorAll('.bd-real').forEach(inp=>{inp.addEventListener('change',async()=>{const fecha=inp.getAttribute('data-fecha');const val=parseFloat(inp.value||'0');$('bdMsg').textContent='Guardando...';const {error}=await supabase.rpc('set_burndown_manual',{p_fecha:fecha,p_real:val});$('bdMsg').textContent=error?('Error: '+error.message):'Guardado.';await loadKpis();await loadBurndownChartAndTable();});});tbody.querySelectorAll('.bd-manual').forEach(chk=>{chk.addEventListener('change',async()=>{const fecha=chk.getAttribute('data-fecha');$('bdMsg').textContent='Actualizando...';let error=null;if(chk.checked){const inputEl=tbody.querySelector('input.bd-real[data-fecha="'+fecha+'"]');const val=parseFloat((inputEl&&inputEl.value)?inputEl.value:'0');const resp=await supabase.rpc('set_burndown_manual',{p_fecha:fecha,p_real:val});error=resp.error;}else{const resp=await supabase.rpc('unset_burndown_manual',{p_fecha:fecha});error=resp.error;}$('bdMsg').textContent=error?('Error: '+error.message):'Listo.';await loadKpis();await loadBurndownChartAndTable();});});const btnRecalc=$('btnRecalc');if(btnRecalc){btnRecalc.onclick=async()=>{$('bdMsg').textContent='Reconstruyendo...';const {error}=await supabase.rpc('reconstruir_burndown_sprint_activo');$('bdMsg').textContent=error?('Error: '+error.message):'Burndown reconstruido.';await loadKpis();await loadBurndownChartAndTable();};}};
async function loadPorLista(){const {data}=await supabase.from('vw_por_lista').select('*');const host=$('avanceListas');if(!host)return;host.innerHTML='';(data||[]).forEach(l=>{const pct=l.asignadas>0?(l.terminadas/l.asignadas):0;const wrap=document.createElement('div');wrap.innerHTML='<div class="flex items-center justify-between mb-1"><span class="font-medium">'+l.lista+'</span><span class="text-sm text-gray-600">'+fmt.pct(pct)+'</span></div><div class="w-full bg-gray-200 rounded-full h-2"><div class="h-2 rounded-full '+(pct>0.6?'bg-emerald-500':pct>0.4?'bg-amber-500':'bg-blue-500')+'" style="width:'+(pct*100).toFixed(0)+'%"></div></div>';host.appendChild(wrap);});}
async function loadPorHistoria(){const {data}=await supabase.from('vw_por_historia').select('*');const host=$('avanceHU');if(!host)return;host.innerHTML='';(data||[]).forEach(h=>{const pct=h.totales>0?(h.terminadas/h.totales):0;const pill=pct>=.8?'bg-emerald-50 text-emerald-700 border-emerald-200':(pct>=.5?'bg-amber-50 text-amber-700 border-amber-200':'bg-blue-50 text-blue-700 border-blue-200');const row=document.createElement('div');row.className='p-3 rounded-lg border flex items-start justify-between';row.innerHTML='<div><div class="font-medium">'+h.id_historia+' · '+h.historia+'</div><div class="text-xs text-gray-500">Lista: '+h.lista+'</div></div><div class="text-sm"><span class="px-2 py-1 rounded-full border '+pill+'">'+fmt.pct(pct)+' <span class="text-gray-500">('+fmt.num(h.totales)+'h totales · '+fmt.num(h.abiertas)+'h abiertas)</span></span></div>';host.appendChild(row);});}
async function loadPorPropietario(){const spr=await supabase.from('sprint').select('horas_por_dia').order('created_at',{ascending:false}).limit(1).maybeSingle();const diasText=$('diasRestantes')?.textContent||'0';const dias=diasText==='—'?0:parseInt(diasText,10);const cap=(spr.data?.horas_por_dia||0)*dias;const {data}=await supabase.from('vw_por_propietario').select('*');const host=$('avanceOwners');if(!host)return;host.innerHTML='';(data||[]).forEach(o=>{const disp=cap;const ok=disp>=o.pendientes;const card=document.createElement('div');card.className='p-4 bg-gray-50 rounded-lg border';card.innerHTML='<div class="font-semibold mb-2">'+o.propietario+'</div><div class="text-sm mb-2">Pendientes: <span class="'+(ok?'text-emerald-600':'text-rose-600')+'">'+fmt.num(o.pendientes)+'h</span> · Disponibles: '+fmt.num(disp)+'h · '+(ok?'OK':'No alcanza')+'</div>';host.appendChild(card);});}
async function loadControlSub(){const pageSizeSel=$('pageSize'),search=$('searchSub'),tbody=$('subBody'),count=$('countSub'),prev=$('prevSub'),next=$('nextSub'),pageLbl=$('pageSub');if(!pageSizeSel||!search||!tbody)return;let page=1,total=0;function strip(s){return (s||'').toString().normalize('NFD').replace(/\p{Diacritic}/gu,'').toLowerCase();}function rowHtml(r){return '<tr class="border-b last:border-0"><td class="py-2 pr-4">'+r.id_subtarea+'</td><td class="py-2 pr-4">'+(r.titulo||'')+'</td><td class="py-2 pr-4">'+(r.estado||'')+'</td><td class="py-2 pr-4">'+(r.propietario||'')+'</td><td class="py-2 pr-4 text-center">'+(r.terminado_manual?'Sí':'No')+'</td><td class="py-2 pr-4 text-center">'+(r.visible?'Sí':'No')+'</td><td class="py-2 pr-4">'+(r.nombre_lista||'')+'</td></tr>'; } async function fetchPage(){const limit=parseInt(pageSizeSel.value,10)||50,from=(page-1)*limit,to=from+limit-1;const qstr=strip(search.value);if(qstr){const all=await supabase.from('vw_control_subtareas').select('*');const filtered=(all.data||[]).filter(r=>strip(Object.values(r).join(' ')).includes(qstr));total=filtered.length;const slice=filtered.slice(from,to+1);tbody.innerHTML=slice.map(r=>rowHtml(r)).join('');const max=Math.max(1,Math.ceil(total/limit));pageLbl.textContent=page+' / '+max;count.textContent=Math.min(total,to+1)+' de '+total;return;}const {data,count:c}=await supabase.from('vw_control_subtareas').select('*',{count:'exact'}).order('id_subtarea').range(from,to);total=c||0;tbody.innerHTML=(data||[]).map(r=>rowHtml(r)).join('');const max=Math.max(1,Math.ceil(total/limit));pageLbl.textContent=page+' / '+max;count.textContent=Math.min(total,to+1)+' de '+total;}search.addEventListener('input',()=>{page=1;fetchPage();});pageSizeSel.addEventListener('change',()=>{page=1;fetchPage();});prev.addEventListener('click',()=>{if(page>1){page--;fetchPage();}});next.addEventListener('click',()=>{const limit=parseInt(pageSizeSel.value,10)||50;const max=Math.max(1,Math.ceil(total/limit));if(page<max){page++;fetchPage();}});await fetchPage();}
const btnSave=$('f_save');if(btnSave){btnSave.addEventListener('click',async()=>{const nombre=$('f_nombre').value.trim();const hs=parseFloat($('f_hsprint').value||'0');const ini=$('f_inicio').value;const fin=$('f_fin').value;const hxd=parseFloat($('f_hxd').value||'0');$('f_msg').textContent='Guardando...';const {error}=await supabase.rpc('new_sprint',{p_nombre:nombre,p_inicio:ini,p_fin:fin,p_horas_sprint:hs,p_horas_por_dia:hxd});if(error){$('f_msg').textContent='Error: '+error.message;return;}$('f_msg').textContent='Sprint registrado. (Se borró info previa)';await supabase.rpc('reconstruir_burndown_sprint_activo');await initDashboard();});}
function parseCSV(file){return new Promise((resolve,reject)=>{Papa.parse(file,{header:true,skipEmptyLines:true,complete:r=>resolve(r.data),error:reject});});}
async function importHistorias(file){const rows=await parseCSV(file);for(const r of rows){const id=(r.id_tarea_principal||r.id_historia||r['id historia']||r['id']||'').toString().trim();if(!id)continue;const lista=(r.nombre_lista||r.lista||'')+'';const hist=(r.nombre_historia||r.historia||r.titulo||'')+'';const {error}=await supabase.rpc('upsert_historia',{p_id_tarea_principal:id,p_nombre_lista:lista,p_nombre_historia:hist});if(error)console.error('historia',id,error.message);}}
function normFecha(v){if(!v)return null;if(/^\d{2}\/\d{2}\/\d{4}$/.test(v)){const [d,m,y]=v.split('/');return y+'-'+m+'-'+d;}return v;}
async function importSub(file){const rows=await parseCSV(file);for(const r of rows){const sid=(r.id_subtarea||r.sub||r['id subtarea']||r['id']||'').toString().trim();const hid=(r.id_tarea_principal||r.historia||r['id historia']||'').toString().trim();if(!sid||!hid)continue;const tit=(r.titulo||r.descripcion||'')+'';const est=(r.estado||'')+'';const own=(r.propietario||r.owner||'')+'';const dur=(r.duracion||r.duracion_txt||r['duración']||'')+'';const f=normFecha((r.fecha_terminacion||r['fecha terminacion']||r['fecha_terminacion']||'')+'');const {error}=await supabase.rpc('upsert_subtarea',{p_id_subtarea:sid,p_id_tarea_principal:hid,p_titulo:tit,p_estado:est,p_propietario:own,p_duracion_txt:dur,p_fecha_terminacion:f});if(error)console.error('subtarea',sid,error.message);}}const btnProc=$('u_process');if(btnProc){btnProc.addEventListener('click',async()=>{$('u_msg').textContent='Procesando CSVs...';try{const fh=$('fileHistorias').files[0];const fs=$('fileSub').files[0];if(fh)await importHistorias(fh);if(fs)await importSub(fs);await supabase.rpc('reconstruir_burndown_sprint_activo');$('u_msg').textContent='Importación completada y burndown actualizado.';await initDashboard();}catch(e){$('u_msg').textContent='Error: '+e.message;}});}const btnRec=$('u_recalc');if(btnRec){btnRec.addEventListener('click',async()=>{$('u_msg').textContent='Reconstruyendo...';const {error}=await supabase.rpc('reconstruir_burndown_sprint_activo');$('u_msg').textContent=error?('Error: '+error.message):'Burndown actualizado.';await initDashboard();});}
async function initDashboard(){await loadSprint();await loadKpis();await loadBurndownChartAndTable();await loadPorLista();await loadPorHistoria();await loadPorPropietario();await loadControlSub();}
initDashboard();